import cv2
print("MAIN STARTED")
from face_detection import FaceDetector
from landmark_detection import LandmarkDetector
from feature_extraction import FeatureExtractor
from temporal_logic import TemporalLogic
from alert_system import AlertSystem
from logger import SessionLogger


def main():
    cap = cv2.VideoCapture(1)
    print("Camera opened:", cap.isOpened())

    face_detector = FaceDetector()
    landmark_detector = LandmarkDetector()
    feature_extractor = FeatureExtractor()
    temporal_logic = TemporalLogic()
    alert = AlertSystem()
    logger = SessionLogger()

    while True:
        ret, frame = cap.read()
        if not ret:
            break

        face_bbox = face_detector.detect(frame)

        if face_bbox is not None:
            landmarks = landmark_detector.detect(frame, face_bbox)

            if landmarks is not None:
                ear, mar = feature_extractor.extract(landmarks)
                state = temporal_logic.update(ear, mar)

                logger.log(
                    ear=ear,
                    mar=mar,
                    state=state
                )

                if state == "DROWSY":
                    alert.play()

                landmark_detector.draw(frame, landmarks)
                face_detector.draw(frame, face_bbox)

        cv2.imshow("Driver Drowsiness Detection", frame)

        if cv2.waitKey(1) & 0xFF == ord('q'):
            break

    logger.close()
    cap.release()
    cv2.destroyAllWindows()


if __name__ == "__main__":
    main()
